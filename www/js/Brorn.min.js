let CALLERSTACK = []
let _ = undefined
var CONNECTION = {}
var REQUESTS = {}
var CONNECTION_COUNTER = 0
var ERR_EXCEPTIONS = false
var ON_GOING_REQUEST = []
let _last_ls_random_result = ''
const _JS_NAME = 'brorn.JS' 
const _JS_VERSION_ = 'v 0.13.1_alpha' 
const _VERSION_ = _JS_VERSION_
const POST = "POST"
const GET = "GET"
const OPTION = "OPTION"
function $CLASS(class_name){return document.getElementsByClassName(class_name)}
function $TAG(tag){_CALLERSTACK();return document.getElementsByTagName(tag)}
function $randint(size){_CALLERSTACK();return Math.floor(Math.random() * size);}
function $ID(id_name){return document.getElementById(id_name)}
function goto(url){window.location.replace(url);}
function redirectto(url){window.location.href = url;}
function $$$_(q){_CALLERSTACK();return document.querySelector(q)}
function $json(str){_CALLERSTACK();return JSON.parse(str)}
function $table(...p){_CALLERSTACK();console.table(...p)}
function $print(...p){_CALLERSTACK();console.log(...p)}
function println(...p){_CALLERSTACK();console.log(...p)}
function $date(){_CALLERSTACK();return new Date()}
function $datetime(){_CALLERSTACK();return new Date().toLocaleString()}

function _CALLERSTACK(){
	var arss = (new Error).stack.split("\n")
	delete arss[0]
	CALLERSTACK.push(arss)
}

function $show_view(ids,classn){
	panel_views = c(classn)
	for (var i = 0; i < panel_views.length; i++) {
		if(ids!=panel_views[i].id){panel_views[i].style.display="none"}
		else{panel_views[i].style.display="block"}
	}
 }

function $http(p){_CALLERSTACK();return new http(p)}
function $send(p){_CALLERSTACK();return new http(p)}
function http(p){
	let RESULT_REQ = undefined
	if(window.navigator.onLine){}
	else{alert("You are not connected to internet")}
	CONNECTION_COUNTER += 1
	const params = populate(p)
	ACTIVE_CONNECTION = (CONNECTION_COUNTER)
	REQUESTS[ACTIVE_CONNECTION] =  params;
	CONNECTION[ACTIVE_CONNECTION] = new XMLHttpRequest();
	this.xhttp = CONNECTION[ACTIVE_CONNECTION];
	this.xhttp.open(REQUESTS[ACTIVE_CONNECTION].method,REQUESTS[ACTIVE_CONNECTION].action,REQUESTS[ACTIVE_CONNECTION].a_sync);
	for (var key in REQUESTS[ACTIVE_CONNECTION].headers){this.xhttp.setRequestHeader(key, REQUESTS[ACTIVE_CONNECTION].headers[key])}
	this.xhttp.onreadystatechange = function(){RESULT_REQ = this};
	this.xhttp.addEventListener("loadend", loadEnd);
	function loadEnd(e) {
		if(parseInt(e.target.status)!=200){REQUESTS[ACTIVE_CONNECTION].err(e)}
		if(RESULT_REQ.readyState == 4) {
			if(RESULT_REQ.status == 200){
				if(REQUESTS[ACTIVE_CONNECTION].response=="all"){REQUESTS[ACTIVE_CONNECTION].func(RESULT_REQ)}
				else if(REQUESTS[ACTIVE_CONNECTION].response=="header"){REQUESTS[ACTIVE_CONNECTION].func(RESULT_REQ.getAllResponseHeaders())}
				else if(REQUESTS[ACTIVE_CONNECTION].response=="text"){REQUESTS[ACTIVE_CONNECTION].func(RESULT_REQ.responseText)}
				else{REQUESTS[ACTIVE_CONNECTION].func(RESULT_REQ.responseText)}
			}
		}
		else if(RESULT_REQ.status == 500 || RESULT_REQ.status == 404 || RESULT_REQ.status == 401){
			REQUESTS[ACTIVE_CONNECTION].func(RESULT_REQ.getAllResponseHeaders)
			ERROR = {"ERROR_REQUEST":CONNECTION[ACTIVE_CONNECTION]}
			_CALLERSTACK();return this.xhttp
		}
		else{REQUESTS[ACTIVE_CONNECTION].on_request(this)}
	}
	this.xhttp.send(params.data);
}

http.prototype.next = async function(func) {this.xhttp.addEventListener('loadend', function(e) {$print("* Next :"+e.type);_CALLERSTACK();return func});}
http.prototype.with = async function(func) {this.xhttp.addEventListener('loadstart', function(e) {$print("* with"+e.type);_CALLERSTACK();return func});}

String.prototype.replaceAt = function(index, replacement) {
	_CALLERSTACK();return this.substr(0, index) + replacement + this.substr(index + replacement.length);
}

function $TRIGGER(params){
	if(params.id==undefined){params.action='#'}
	if(params.event==undefined){params.event="click"}
	if(params.func==undefined){params.func= function(){alert(params)}}
	$(params.id).addEventListener(params.event, params.func);
}
function populate(params){
	if(params.action==undefined){params.action='/'}
	if(params.data==undefined){params.data=$DATA({'_DATA':'NULL'})}
	if(params.func==undefined){params.func=function(res){$print(res)}}
	if(params.err==undefined){params.err=function(res){$print(res);$print("ERROR"+JSON.stringify(res))}}
	if(params.on_request==undefined){params.on_request=function(ret){}}
	if(params.method==undefined){params.method='POST'}
	if(params.a_sync==undefined){params.a_sync=true}
	if(params.response==undefined){params.type="responseText"}
	if(params.headers==undefined){params.headers={}}
	_CALLERSTACK();return params
}
function num_comma(x){_CALLERSTACK();return Money(x)}
function money(x){_CALLERSTACK();return Money(x)}
function Money(x) {
	if(x==null){_CALLERSTACK();return x}
	else{_CALLERSTACK();return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");}
}

function ls_random(ls){
	while(true){
		res = ls[Math.floor(Math.random() * ls.length)]
		if(res==_last_ls_random_result){continue}
		else{_last_ls_random_result = res;_CALLERSTACK();return res}
	}
}

function $DATA(d){var data_form = new FormData();for(var key in d){data_form.append(key, d[key])};_CALLERSTACK();return data_form}
FormData.prototype.appendFile = function(file_tag) {for (var i = 0; i < file_tag.files.length; i++) {this.append(file_tag.id+i,file_tag.files[i])};_CALLERSTACK();return this}

function hashCode(str, seed = 0) {
	let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
	for (let i = 0, ch; i < str.length; i++) {ch = str.charCodeAt(i);h1 = Math.imul(h1 ^ ch, 2654435761);h2 = Math.imul(h2 ^ ch, 1597334677);}
	h1 = Math.imul(h1 ^ (h1>>>16), 2246822507) ^ Math.imul(h2 ^ (h2>>>13), 3266489909);
	h2 = Math.imul(h2 ^ (h2>>>16), 2246822507) ^ Math.imul(h1 ^ (h1>>>13), 3266489909);
	_CALLERSTACK();return 4294967296 * (2097151 & h2) + (h1>>>0);
};

String.prototype.toCamelCase = function() {
	_CALLERSTACK();return this.replace(/^([A-Z])|\s(\w)/g, function(match, p1, p2, offset) {
		if (p2) _CALLERSTACK();return p2.toUpperCase();
		_CALLERSTACK();return p1.toLowerCase();        
	});
};

function timeout(func,sec){window.setTimeout(func,sec)}

var url_args =  url_args_()
function url_args_ (){
	var url = new URL(document.location.toString());let obj = {};
	var c = url.searchParams.forEach((value, key) => {obj[key] = value;});
	_CALLERSTACK();return(obj);
}

var w;
function JSWorker() {
	if(typeof(Worker) !== "undefined") {
		if(typeof(w) == "undefined") {w = new Worker("demo_workers.js");}
		w.onmessage = function(event) {_CALLERSTACK();return event;};
	} else {alert("Sorry, your browser does not support Web Workers...");}
}

function stopWorker() { w.terminate();w = undefined;}

function gen_code(length) {
	for (var s=''; s.length < length; s += 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'.charAt(Math.random()*62|0));
	_CALLERSTACK();return s;
}

function gen_decode(str) {
	for (var s=str; s.length < length; s += 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'.charAt(Math.random()*62|0));
	_CALLERSTACK();return s;
}

function getCookie(cname) {
	let name = cname + "=";
	let decodedCookie = decodeURIComponent(document.cookie);
	let ca = decodedCookie.split(';');
	for(let i = 0; i <ca.length; i++) {
		let c = ca[i];
		while (c.charAt(0) == ' ') {
			c = c.substring(1);
		}
		if (c.indexOf(name) == 0) {
			return c.substring(name.length, c.length);
		}
	}
	return undefined;
}

function input_validate(_class_){
	var class_ = $CLASS(_class_);var arr_val = []
	for (var i = 0; i < class_.length; i++) {arr_val.push(class_[i].value.length)}
	return !arr_val.includes(0)
}

function search_str_arr(strs,_arr){
	return _arr.every(item => strs.toLowerCase().includes(item.toLowerCase()));
}

function add_class2class(class_,...cl){
	const elmnts = document.querySelectorAll("."+class_);

	for (const elmnt of elmnts) {
		elmnt.classList.add(...cl);
	}
}

function isOnline(){
	return window.navigator.onLine;
}